(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{326:function(e,t,n){"use strict";n(40);var r=n(12),a=n.n(r),o=n(0),s=n.n(o),c=n(97),i=n(330),u=n.n(i),p=c.b.div.withConfig({displayName:"ErrorBoundary__Container",componentId:"qh8x2j-0"})(["margin:10px;"]),l=c.b.div.withConfig({displayName:"ErrorBoundary__ErrorTitle",componentId:"qh8x2j-1"})(["margin-bottom:10px;"]),d=Object(c.b)(u.a).withConfig({displayName:"ErrorBoundary__ReloadButton",componentId:"qh8x2j-2"})(["margin-top:10px !important;"]),f=function(e){function t(t){var n;return(n=e.call(this,t)||this).state={error:null},n}return a()(t,e),t.getDerivedStateFromError=function(e){return{error:e}},t.prototype.render=function(){var e=this,t=this.state.error;if(t)return console.log("error:",t),s.a.createElement(p,null,s.a.createElement(l,null,"Oh je, es ist ein Fehler aufgetreten! Bericht:"),s.a.createElement("div",null,t.message),s.a.createElement(d,{variant:"outlined",onClick:function(){"undefined"!=typeof window&&window.location.reload(!1)}},"Neu laden"));var n=this.props.children;return s.a.Children.map(n,function(t){return s.a.cloneElement(t,Object.assign({},e.props))})},t}(o.Component);t.a=f},332:function(e,t,n){"use strict";n(40);var r=n(0),a=n.n(r),o=n(101),s=(n(98),n(444),n(152),n(150),n(328)),c=n.n(s),i=(n(331),n(329)),u=n.n(i),p=n(12),l=n.n(p),d=n(41),f=n.n(d),h=n(391),m=n.n(h),b=(n(177),n(84)),g=n(499),w=n(366),v=n.n(w),y=(n(345),n(368)),j=n(384),x=n(369),S=n(427),D=n(373);y.a.plugin(j.a),y.a.plugin(x.a);var N=function(){var e=u()(c.a.mark(function e(t){var n,r,a;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,y.a.create({name:"messages",adapter:"idb"});case 3:n=e.sent,e.next=9;break;case 6:throw e.prev=6,e.t0=e.catch(0),e.t0;case 9:return e.next=11,n.collection({name:"projectdef",schema:S,pouchSettings:{fetch:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.credentials="include",fetch(e,t)})}});case 11:return r=e.sent,t.addDb({name:"messages",db:n}),console.log("createMessageDb",{messageDb:n,projectDefCollection:r}),e.next=16,r.sync({remote:Object(D.a)()+"/messages/",options:{live:!0,retry:!0},query:n.projectdef.find().where("type").eq("projectDef")});case 16:a=e.sent,t.addSync({name:"messageDbProjectDef",sync:a});case 18:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}(),k=(n(65),function(){if("undefined"==typeof window)return"https://erfassen.ch:5984/erfassen";var e="localhost"===window.location.hostname.replace("www.",""),t=e?"localhost":window.location.hostname;return e?"http://"+t+":5984/erfassen":"https://erfassen.ch:5984/erfassen"}),O=(n(159),n(160),n(428)),E=(n(461),n(464),n(429),n(409),n(466)),C=n.n(E),q=n(399),_=function(e){var t=e.projects,n=e.authState,r=n.state.dbs;if(!r)return console.log("provideProjectDbs: no dbs found");var a=Object.keys(r).filter(function(e){return e.startsWith("project_")}),o=C()(t,a),s=C()(a,t);console.log("provideProjectDbs",{existingProjects:a,usersProjects:t,projectsToAdd:o,projectsToRemove:s});var c=o,i=Array.isArray(c),u=0;for(c=i?c:c[Symbol.iterator]();;){var p;if(i){if(u>=c.length)break;p=c[u++]}else{if((u=c.next()).done)break;p=u.value}var l=p;Object(q.a)({projectName:l,authState:n})}};y.a.plugin(x.a);var A=function(){var e=u()(c.a.mark(function e(t){var n,r,a,o,s,i,u,p;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.authState,r=t.email,a=n.state,o=a.dbs,s=a.syncs,i=m()(r),e.prev=3,e.next=6,y.a.create({name:i,adapter:"idb",pouchSettings:{fetch:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.credentials="include",fetch(e,t)})}});case 6:return u=e.sent,e.next=9,u.collection({name:"user",schema:O,pouchSettings:{fetch:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.credentials="include",fetch(e,t)})}});case 9:e.next=19;break;case 11:if(e.prev=11,e.t0=e.catch(3),!e.t0.message.includes("already exists")){e.next=18;break}return console.log("user db already exists"),e.abrupt("return");case 18:throw e.t0;case 19:return n.addDb({name:i,db:u}),!!s&&!!s[i]||(p=u.user.sync({remote:Object(D.a)()+"/"+i+"/",options:{live:!0,retry:!0},query:u.user.find().where("type").eq("user")})),n.addSync({name:"user",sync:p}),p.docs$.subscribe(function(e){return _({projects:e.projects,authState:n})}),console.log("createAndSyncUserCollection",{dbs:o,userDb:u,userDbName:i,sync:p}),e.abrupt("return");case 26:case"end":return e.stop()}},e,this,[[3,11]])}));return function(t){return e.apply(this,arguments)}}();b.a.plugin(g.a);var P=function(e){function t(){var t;(t=e.call(this)||this).setAuthDb=function(e){t.setState({authDb:e})},t.setEmail=function(e){t.setState({email:e})},t.setSignupOpen=function(e){t.setState({signupOpen:e})},t.setLoginOpen=function(e){t.setState({loginOpen:e})},t.signUp=function(){var e=u()(c.a.mark(function e(n){var r,a;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.email,a=n.password,e.prev=1,e.next=4,t.logOut();case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1),console.log("Auth, signUp: Error logging out:",e.t0);case 9:return e.prev=9,e.next=12,t.state.authDb.signUp(r,a);case 12:e.next=17;break;case 14:e.prev=14,e.t1=e.catch(9),console.log("Signup: error logging in:",e.t1);case 17:return t.setSignupOpen(!1),e.prev=18,e.next=21,t.logIn({email:r,password:a});case 21:e.next=26;break;case 23:throw e.prev=23,e.t2=e.catch(18),e.t2;case 26:case"end":return e.stop()}},e,this,[[1,6],[9,14],[18,23]])}));return function(t){return e.apply(this,arguments)}}(),t.logIn=function(){var e=u()(c.a.mark(function e(n){var r,a,o,s,i,u,p;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.email,a=n.password,e.next=3,t.logOut();case 3:return e.prev=3,e.next=6,t.state.authDb.logIn(r,a);case 6:o=e.sent,e.next=16;break;case 9:if(e.prev=9,e.t0=e.catch(3),"unauthorized"!==e.t0.name&&"forbidden"!==e.t0.name){e.next=15;break}throw new Error("Name oder Passwort stimmt nicht");case 15:throw e.t0;case 16:return t.setState({email:o.name,loginOpen:!1,authDb:new b.a(k())}),e.next=19,A({email:r,authState:f()(f()(t))});case 19:return e.next=21,N(f()(f()(t))).catch(function(e){throw e});case 21:return s=m()(r),i=t.state.dbs[s],u=i.user,e.next=26,u.find().exec();case 26:(p=e.sent)&&p[0]&&(console.log("logIn",{userDbName:s,userDb:i,userCollection:u,userDoc:p[0]}),_({projects:p[0].projects,authState:f()(f()(t))}));case 28:case"end":return e.stop()}},e,this,[[3,9]])}));return function(t){return e.apply(this,arguments)}}(),t.logOut=u()(c.a.mark(function e(){var n,r,a;return c.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.state.authDb.logOut();case 3:e.next=8;break;case 5:throw e.prev=5,e.t0=e.catch(0),e.t0;case 8:if(n=t.state,r=n.dbs,a=n.syncs,r){e.next=11;break}return e.abrupt("return");case 11:return Object.values(r).forEach(function(e){return e.remove()}),Object.values(a).forEach(function(e){return e.cancel()}),t.setState({email:null,loginOpen:!1,dbs:null,syncs:{}}),e.abrupt("return");case 15:case"end":return e.stop()}},e,this,[[0,5]])})),t.setDbs=function(e){t.setState({dbs:e})},t.addDb=function(e){var n=e.name,r=e.db;t.setState(function(e){var t;console.log("Auth, addDb",{dbs:e.dbs});var a=Object.assign({},e.dbs,((t={})[n]=r,t));return console.log("Auth, addDb",{newDbs:a}),window.dbs=a,{dbs:a}})},t.setSyncs=function(e){t.setState({syncs:e})},t.addSync=function(e){var n=e.name,r=e.sync;t.setState(function(e){var t,a=Object.assign({},e.syncs,((t={})[n]=r,t));return{dbs:e.dbs,syncs:a}})};var n=new b.a(k()),r="undefined"==typeof window?null:window.dbs||null;return t.state={authDb:n,email:null,signupOpen:!1,loginOpen:!1,dbs:r,syncs:{}},n.getSession().then(function(e){var n=v()(e,"userCtx.name",null);n&&(t.setState({email:n}),A({email:n,authState:f()(f()(t))}),("undefined"!=typeof window&&!window.dbs||"undefined"==typeof window)&&N(f()(f()(t))).catch(function(e){throw e}))}).catch(function(e){throw e}),t}return l()(t,e),t}(o.a);t.a=function(e){return function(t){return a.a.createElement(o.c,{to:[P]},function(n){return a.a.createElement(e,Object.assign({authState:n},t))})}}},373:function(e,t,n){"use strict";n(65);t.a=function(){if("undefined"==typeof window)return"https://erfassen.ch:5984";var e="localhost"===window.location.hostname.replace("www.",""),t=e?"localhost":window.location.hostname;return e?"http://"+t+":5984":"https://erfassen.ch:5984"}},391:function(e,t,n){n(65),e.exports=function(e){return"user_"+e.toLowerCase().replace("@","_at_").replace(".","_p_")}},399:function(e,t,n){"use strict";var r=n(328),a=n.n(r),o=(n(150),n(345),n(159),n(160),n(152),n(98),n(409),n(331),n(329)),s=n.n(o),c=n(368),i=n(384),u=n(369),p=(n(65),function(e){var t=e.creatorName,n=e.projectName,r="project_"+t.toLowerCase().replace("@","_at_").replace(".","_p_")+"_"+n;return/^[a-z][a-z0-9_$()+\/-]*$/.test(r)?r:console.log("Name is not valid db name")}),l=n(430),d=n(373);c.a.plugin(i.a),c.a.plugin(u.a);t.a=function(){var e=s()(a.a.mark(function e(t){var n,r,o,s,i,u,f,h,m;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.projectName,r=t.authState,o=r.state,s=o.dbs,i=o.email,u=p({creatorName:i,projectName:n}),!Object.keys(s).includes(u)){e.next=6;break}throw new Error("Dieser Name wird schon benutzt");case 6:return e.prev=6,e.next=9,s.messages.projectdef.insert({projectName:n,creatorName:i,type:"projectDef"});case 9:e.next=14;break;case 11:throw e.prev=11,e.t0=e.catch(6),e.t0;case 14:return e.prev=14,e.next=17,c.a.create({name:u,adapter:"idb"});case 17:f=e.sent,e.next=23;break;case 20:throw e.prev=20,e.t1=e.catch(14),e.t1;case 23:return e.next=25,f.collection({name:"projectdef",schema:l,pouchSettings:{fetch:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.credentials="include",fetch(e,t)})}});case 25:return h=e.sent,r.addDb({name:u,db:f}),e.next=29,h.sync({remote:Object(d.a)()+"/"+u+"/",options:{live:!0,retry:!0},query:f.projectdef.find().where("type").eq("projectDef")});case 29:return m=e.sent,r.addSync({name:u+"ProjectDef",sync:m}),console.log("NewProject",{projectDefCollection:h}),e.prev=32,e.next=35,h.insert({_id:"projectDef",projectName:n,creatorName:i,type:"projectDef"});case 35:e.next=40;break;case 37:throw e.prev=37,e.t2=e.catch(32),e.t2;case 40:console.log("finished creating new project");case 41:case"end":return e.stop()}},e,this,[[6,11],[14,20],[32,37]])}));return function(t){return e.apply(this,arguments)}}()},427:function(e){e.exports={title:"project definition schema",version:0,description:"describes a project",type:"object",properties:{type:{type:"string"},projectName:{type:"string"},creatorName:{type:"string"}},required:["projectName","creatorName"]}},428:function(e){e.exports={title:"user doc schema",version:0,description:"describes a user doc",type:"object",properties:{type:{type:"string"},email:{type:"string"},projects:{type:"array",items:{type:"string"}}},required:["email","type"]}},430:function(e){e.exports={title:"project definition schema",version:0,description:"describes a project",type:"object",properties:{type:{type:"string"},projectName:{type:"string"},creatorName:{type:"string"}},required:["projectName","creatorName"]}},451:function(e,t){},460:function(e,t){}}]);
//# sourceMappingURL=3-d085540b41ec3ffa0bfc.js.map